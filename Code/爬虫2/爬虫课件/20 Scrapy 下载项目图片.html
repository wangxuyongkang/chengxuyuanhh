<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 9.0.5 (458014)"/><meta name="altitude" content="36"/><meta name="author" content="李居豪"/><meta name="created" content="2019-05-29 05:23:59 +0000"/><meta name="latitude" content="39.63160386470755"/><meta name="longitude" content="116.0505396072704"/><meta name="source" content="desktop.mac"/><meta name="updated" content="2019-05-29 13:53:23 +0000"/><meta name="content-class" content="yinxiang.markdown"/><title>20 Scrapy 下载项目图片</title></head><body><div style="font-size: 14px; margin: 0; padding: 0; width: 100%;"><h3 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 27px; color: #333;">下载项目图片</h3>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">Scrapy提供了一个 item pipeline ，来下载属于某个特定项目的图片，比如，当你抓取产品时，也想把它们的图片下载到本地。</p>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">这条管道，被称作图片管道，在 ImagesPipeline 类中实现，提供了一个方便并具有额外特性的方法，来下载并本地存储图片:</p>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">Pillow 是用来生成缩略图，并将图片归一化为JPEG/RGB格式，因此为了使用图片管道，你需要安装这个库。 Python Imaging Library (PIL) 在大多数情况下是有效的，但众所周知，在一些设置里会出现问题，因此我们推荐使用 Pillow 而不是 PIL.</p>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;"><strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">使用图片管道<br/>
当使用 ImagesPipeline ，典型的工作流程如下所示:</strong></p>
<ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;">
<li style="line-height: 160%; box-sizing: content-box; position: relative;">在一个爬虫里，你抓取一个项目，把其中图片的URL放入 image_urls 组内。</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">项目从爬虫内返回，进入项目管道。</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">当项目进入 ImagesPipeline，image_urls 组内的URLs将被Scrapy的调度器和下载器（这意味着调度器和下载器的中间件可以复用）安排下载，当优先级更高，会在其他页面被抓取前处理。项目会在这个特定的管道阶段保持“locker”的状态，直到完成图片的下载（或者由于某些原因未完成下载）。</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">当图片下载完，另一个组(images)将被更新到结构中。这个组将包含一个字典列表，其中包括下载图片的信息，比如下载路径、源抓取地址（从 image_urls 组获得）和图片的校验码。 images 列表中的图片顺序将和源 image_urls 组保持一致。如果某个图片下载失败，将会记录下错误信息，图片也不会出现在 images 组中。</li>
</ul>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;"><strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">实现定制图片管道</strong></p>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;">from scrapy.contrib.pipeline.images import ImagesPipeline
import scrapy
from scrapy.exceptions import DropItem
import os
from scrapy.utils.project import get_project_settings

#下载图片
image_store = get_project_settings().get('IMAGES_STORE')
class jobboleImagePipline(ImagesPipeline):

    def get_media_requests(self, item, info):

        return scrapy.Request(item['coverImage'])
        # return [Request(x) for x in item.get(self.images_urls_field, [])]

    def item_completed(self, results, item, info):
        print(results)
        #获取图片下载成功的请求路径
        image_paths = [x['path'] for ok, x in results if ok]
        #判断图片是否下载成功
        if not image_paths:

            raise DropItem("Item contains no images")

        #替换图片的名称，自定义图片名称
        os.rename(image_store+'/'+image_paths[0],
                  image_store+'/'+item['title']+'.jpg')
        #将图片地址赋值给item
        item['localImagePath'] = image_store+'/'+item['title']+'.jpg'

        return item
</code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">解释</h4>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;">item_completed() 接收的元组列表需要保证与 get_media_requests() 方法返回请求的顺序相一致。下面是 results 参数的一个典型值:

[(True,
  {'checksum': '2b00042f7481c7b056c4b410d28f33cf',
   'path': 'full/7d97e98f8af710c7e7fe703abc8f639e0ee507c4.jpg',
   'url': 'http://www.example.com/images/product1.jpg'}),
 (True,
  {'checksum': 'b9628c4ab9b595f72f280b90c4fd093d',
   'path': 'full/1ca5879492b8fd606df1964ea3c1e2f4520f076f.jpg',
   'url': 'http://www.example.com/images/product2.jpg'}),
 (False,
  Failure(...))]
</code></pre>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;"><strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">默认 get_media_requests() 方法返回 None ，这意味着项目中没有图片可下载。</strong></p>
</div><center style="display:none !important;visibility:collapse !important;height:0 !important;white-space:nowrap;width:100%;overflow:hidden">%0A%23%23%23%20%E4%B8%8B%E8%BD%BD%E9%A1%B9%E7%9B%AE%E5%9B%BE%E7%89%87%0A%0AScrapy%E6%8F%90%E4%BE%9B%E4%BA%86%E4%B8%80%E4%B8%AA%20item%20pipeline%20%EF%BC%8C%E6%9D%A5%E4%B8%8B%E8%BD%BD%E5%B1%9E%E4%BA%8E%E6%9F%90%E4%B8%AA%E7%89%B9%E5%AE%9A%E9%A1%B9%E7%9B%AE%E7%9A%84%E5%9B%BE%E7%89%87%EF%BC%8C%E6%AF%94%E5%A6%82%EF%BC%8C%E5%BD%93%E4%BD%A0%E6%8A%93%E5%8F%96%E4%BA%A7%E5%93%81%E6%97%B6%EF%BC%8C%E4%B9%9F%E6%83%B3%E6%8A%8A%E5%AE%83%E4%BB%AC%E7%9A%84%E5%9B%BE%E7%89%87%E4%B8%8B%E8%BD%BD%E5%88%B0%E6%9C%AC%E5%9C%B0%E3%80%82%0A%0A%E8%BF%99%E6%9D%A1%E7%AE%A1%E9%81%93%EF%BC%8C%E8%A2%AB%E7%A7%B0%E4%BD%9C%E5%9B%BE%E7%89%87%E7%AE%A1%E9%81%93%EF%BC%8C%E5%9C%A8%20ImagesPipeline%20%E7%B1%BB%E4%B8%AD%E5%AE%9E%E7%8E%B0%EF%BC%8C%E6%8F%90%E4%BE%9B%E4%BA%86%E4%B8%80%E4%B8%AA%E6%96%B9%E4%BE%BF%E5%B9%B6%E5%85%B7%E6%9C%89%E9%A2%9D%E5%A4%96%E7%89%B9%E6%80%A7%E7%9A%84%E6%96%B9%E6%B3%95%EF%BC%8C%E6%9D%A5%E4%B8%8B%E8%BD%BD%E5%B9%B6%E6%9C%AC%E5%9C%B0%E5%AD%98%E5%82%A8%E5%9B%BE%E7%89%87%3A%0A%0APillow%20%E6%98%AF%E7%94%A8%E6%9D%A5%E7%94%9F%E6%88%90%E7%BC%A9%E7%95%A5%E5%9B%BE%EF%BC%8C%E5%B9%B6%E5%B0%86%E5%9B%BE%E7%89%87%E5%BD%92%E4%B8%80%E5%8C%96%E4%B8%BAJPEG%2FRGB%E6%A0%BC%E5%BC%8F%EF%BC%8C%E5%9B%A0%E6%AD%A4%E4%B8%BA%E4%BA%86%E4%BD%BF%E7%94%A8%E5%9B%BE%E7%89%87%E7%AE%A1%E9%81%93%EF%BC%8C%E4%BD%A0%E9%9C%80%E8%A6%81%E5%AE%89%E8%A3%85%E8%BF%99%E4%B8%AA%E5%BA%93%E3%80%82%20Python%20Imaging%20Library%20(PIL)%20%E5%9C%A8%E5%A4%A7%E5%A4%9A%E6%95%B0%E6%83%85%E5%86%B5%E4%B8%8B%E6%98%AF%E6%9C%89%E6%95%88%E7%9A%84%EF%BC%8C%E4%BD%86%E4%BC%97%E6%89%80%E5%91%A8%E7%9F%A5%EF%BC%8C%E5%9C%A8%E4%B8%80%E4%BA%9B%E8%AE%BE%E7%BD%AE%E9%87%8C%E4%BC%9A%E5%87%BA%E7%8E%B0%E9%97%AE%E9%A2%98%EF%BC%8C%E5%9B%A0%E6%AD%A4%E6%88%91%E4%BB%AC%E6%8E%A8%E8%8D%90%E4%BD%BF%E7%94%A8%20Pillow%20%E8%80%8C%E4%B8%8D%E6%98%AF%20PIL.%0A%0A**%E4%BD%BF%E7%94%A8%E5%9B%BE%E7%89%87%E7%AE%A1%E9%81%93%0A%E5%BD%93%E4%BD%BF%E7%94%A8%20ImagesPipeline%20%EF%BC%8C%E5%85%B8%E5%9E%8B%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B%E5%A6%82%E4%B8%8B%E6%89%80%E7%A4%BA%3A**%0A%0A-%20%E5%9C%A8%E4%B8%80%E4%B8%AA%E7%88%AC%E8%99%AB%E9%87%8C%EF%BC%8C%E4%BD%A0%E6%8A%93%E5%8F%96%E4%B8%80%E4%B8%AA%E9%A1%B9%E7%9B%AE%EF%BC%8C%E6%8A%8A%E5%85%B6%E4%B8%AD%E5%9B%BE%E7%89%87%E7%9A%84URL%E6%94%BE%E5%85%A5%20image_urls%20%E7%BB%84%E5%86%85%E3%80%82%0A-%20%E9%A1%B9%E7%9B%AE%E4%BB%8E%E7%88%AC%E8%99%AB%E5%86%85%E8%BF%94%E5%9B%9E%EF%BC%8C%E8%BF%9B%E5%85%A5%E9%A1%B9%E7%9B%AE%E7%AE%A1%E9%81%93%E3%80%82%0A-%20%E5%BD%93%E9%A1%B9%E7%9B%AE%E8%BF%9B%E5%85%A5%20ImagesPipeline%EF%BC%8Cimage_urls%20%E7%BB%84%E5%86%85%E7%9A%84URLs%E5%B0%86%E8%A2%ABScrapy%E7%9A%84%E8%B0%83%E5%BA%A6%E5%99%A8%E5%92%8C%E4%B8%8B%E8%BD%BD%E5%99%A8%EF%BC%88%E8%BF%99%E6%84%8F%E5%91%B3%E7%9D%80%E8%B0%83%E5%BA%A6%E5%99%A8%E5%92%8C%E4%B8%8B%E8%BD%BD%E5%99%A8%E7%9A%84%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%8F%AF%E4%BB%A5%E5%A4%8D%E7%94%A8%EF%BC%89%E5%AE%89%E6%8E%92%E4%B8%8B%E8%BD%BD%EF%BC%8C%E5%BD%93%E4%BC%98%E5%85%88%E7%BA%A7%E6%9B%B4%E9%AB%98%EF%BC%8C%E4%BC%9A%E5%9C%A8%E5%85%B6%E4%BB%96%E9%A1%B5%E9%9D%A2%E8%A2%AB%E6%8A%93%E5%8F%96%E5%89%8D%E5%A4%84%E7%90%86%E3%80%82%E9%A1%B9%E7%9B%AE%E4%BC%9A%E5%9C%A8%E8%BF%99%E4%B8%AA%E7%89%B9%E5%AE%9A%E7%9A%84%E7%AE%A1%E9%81%93%E9%98%B6%E6%AE%B5%E4%BF%9D%E6%8C%81%E2%80%9Clocker%E2%80%9D%E7%9A%84%E7%8A%B6%E6%80%81%EF%BC%8C%E7%9B%B4%E5%88%B0%E5%AE%8C%E6%88%90%E5%9B%BE%E7%89%87%E7%9A%84%E4%B8%8B%E8%BD%BD%EF%BC%88%E6%88%96%E8%80%85%E7%94%B1%E4%BA%8E%E6%9F%90%E4%BA%9B%E5%8E%9F%E5%9B%A0%E6%9C%AA%E5%AE%8C%E6%88%90%E4%B8%8B%E8%BD%BD%EF%BC%89%E3%80%82%0A-%20%E5%BD%93%E5%9B%BE%E7%89%87%E4%B8%8B%E8%BD%BD%E5%AE%8C%EF%BC%8C%E5%8F%A6%E4%B8%80%E4%B8%AA%E7%BB%84(images)%E5%B0%86%E8%A2%AB%E6%9B%B4%E6%96%B0%E5%88%B0%E7%BB%93%E6%9E%84%E4%B8%AD%E3%80%82%E8%BF%99%E4%B8%AA%E7%BB%84%E5%B0%86%E5%8C%85%E5%90%AB%E4%B8%80%E4%B8%AA%E5%AD%97%E5%85%B8%E5%88%97%E8%A1%A8%EF%BC%8C%E5%85%B6%E4%B8%AD%E5%8C%85%E6%8B%AC%E4%B8%8B%E8%BD%BD%E5%9B%BE%E7%89%87%E7%9A%84%E4%BF%A1%E6%81%AF%EF%BC%8C%E6%AF%94%E5%A6%82%E4%B8%8B%E8%BD%BD%E8%B7%AF%E5%BE%84%E3%80%81%E6%BA%90%E6%8A%93%E5%8F%96%E5%9C%B0%E5%9D%80%EF%BC%88%E4%BB%8E%20image_urls%20%E7%BB%84%E8%8E%B7%E5%BE%97%EF%BC%89%E5%92%8C%E5%9B%BE%E7%89%87%E7%9A%84%E6%A0%A1%E9%AA%8C%E7%A0%81%E3%80%82%20images%20%E5%88%97%E8%A1%A8%E4%B8%AD%E7%9A%84%E5%9B%BE%E7%89%87%E9%A1%BA%E5%BA%8F%E5%B0%86%E5%92%8C%E6%BA%90%20image_urls%20%E7%BB%84%E4%BF%9D%E6%8C%81%E4%B8%80%E8%87%B4%E3%80%82%E5%A6%82%E6%9E%9C%E6%9F%90%E4%B8%AA%E5%9B%BE%E7%89%87%E4%B8%8B%E8%BD%BD%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%B0%86%E4%BC%9A%E8%AE%B0%E5%BD%95%E4%B8%8B%E9%94%99%E8%AF%AF%E4%BF%A1%E6%81%AF%EF%BC%8C%E5%9B%BE%E7%89%87%E4%B9%9F%E4%B8%8D%E4%BC%9A%E5%87%BA%E7%8E%B0%E5%9C%A8%20images%20%E7%BB%84%E4%B8%AD%E3%80%82%0A%0A%0A**%E5%AE%9E%E7%8E%B0%E5%AE%9A%E5%88%B6%E5%9B%BE%E7%89%87%E7%AE%A1%E9%81%93**%0A%60%60%60%0Afrom%20scrapy.contrib.pipeline.images%20import%20ImagesPipeline%0Aimport%20scrapy%0Afrom%20scrapy.exceptions%20import%20DropItem%0Aimport%20os%0Afrom%20scrapy.utils.project%20import%20get_project_settings%0A%0A%23%E4%B8%8B%E8%BD%BD%E5%9B%BE%E7%89%87%0Aimage_store%20%3D%20get_project_settings().get('IMAGES_STORE')%0Aclass%20jobboleImagePipline(ImagesPipeline)%3A%0A%0A%20%20%20%20def%20get_media_requests(self%2C%20item%2C%20info)%3A%0A%0A%20%20%20%20%20%20%20%20return%20scrapy.Request(item%5B'coverImage'%5D)%0A%20%20%20%20%20%20%20%20%23%20return%20%5BRequest(x)%20for%20x%20in%20item.get(self.images_urls_field%2C%20%5B%5D)%5D%0A%0A%20%20%20%20def%20item_completed(self%2C%20results%2C%20item%2C%20info)%3A%0A%20%20%20%20%20%20%20%20print(results)%0A%20%20%20%20%20%20%20%20%23%E8%8E%B7%E5%8F%96%E5%9B%BE%E7%89%87%E4%B8%8B%E8%BD%BD%E6%88%90%E5%8A%9F%E7%9A%84%E8%AF%B7%E6%B1%82%E8%B7%AF%E5%BE%84%0A%20%20%20%20%20%20%20%20image_paths%20%3D%20%5Bx%5B'path'%5D%20for%20ok%2C%20x%20in%20results%20if%20ok%5D%0A%20%20%20%20%20%20%20%20%23%E5%88%A4%E6%96%AD%E5%9B%BE%E7%89%87%E6%98%AF%E5%90%A6%E4%B8%8B%E8%BD%BD%E6%88%90%E5%8A%9F%0A%20%20%20%20%20%20%20%20if%20not%20image_paths%3A%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20raise%20DropItem(%22Item%20contains%20no%20images%22)%0A%0A%20%20%20%20%20%20%20%20%23%E6%9B%BF%E6%8D%A2%E5%9B%BE%E7%89%87%E7%9A%84%E5%90%8D%E7%A7%B0%EF%BC%8C%E8%87%AA%E5%AE%9A%E4%B9%89%E5%9B%BE%E7%89%87%E5%90%8D%E7%A7%B0%0A%20%20%20%20%20%20%20%20os.rename(image_store%2B'%2F'%2Bimage_paths%5B0%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20image_store%2B'%2F'%2Bitem%5B'title'%5D%2B'.jpg')%0A%20%20%20%20%20%20%20%20%23%E5%B0%86%E5%9B%BE%E7%89%87%E5%9C%B0%E5%9D%80%E8%B5%8B%E5%80%BC%E7%BB%99item%0A%20%20%20%20%20%20%20%20item%5B'localImagePath'%5D%20%3D%20image_store%2B'%2F'%2Bitem%5B'title'%5D%2B'.jpg'%0A%0A%20%20%20%20%20%20%20%20return%20item%0A%60%60%60%0A%0A%23%23%23%23%20%E8%A7%A3%E9%87%8A%0A%0A%60%60%60%0Aitem_completed()%20%E6%8E%A5%E6%94%B6%E7%9A%84%E5%85%83%E7%BB%84%E5%88%97%E8%A1%A8%E9%9C%80%E8%A6%81%E4%BF%9D%E8%AF%81%E4%B8%8E%20get_media_requests()%20%E6%96%B9%E6%B3%95%E8%BF%94%E5%9B%9E%E8%AF%B7%E6%B1%82%E7%9A%84%E9%A1%BA%E5%BA%8F%E7%9B%B8%E4%B8%80%E8%87%B4%E3%80%82%E4%B8%8B%E9%9D%A2%E6%98%AF%20results%20%E5%8F%82%E6%95%B0%E7%9A%84%E4%B8%80%E4%B8%AA%E5%85%B8%E5%9E%8B%E5%80%BC%3A%0A%0A%5B(True%2C%0A%20%20%7B'checksum'%3A%20'2b00042f7481c7b056c4b410d28f33cf'%2C%0A%20%20%20'path'%3A%20'full%2F7d97e98f8af710c7e7fe703abc8f639e0ee507c4.jpg'%2C%0A%20%20%20'url'%3A%20'http%3A%2F%2Fwww.example.com%2Fimages%2Fproduct1.jpg'%7D)%2C%0A%20(True%2C%0A%20%20%7B'checksum'%3A%20'b9628c4ab9b595f72f280b90c4fd093d'%2C%0A%20%20%20'path'%3A%20'full%2F1ca5879492b8fd606df1964ea3c1e2f4520f076f.jpg'%2C%0A%20%20%20'url'%3A%20'http%3A%2F%2Fwww.example.com%2Fimages%2Fproduct2.jpg'%7D)%2C%0A%20(False%2C%0A%20%20Failure(...))%5D%0A%60%60%60%0A%0A**%E9%BB%98%E8%AE%A4%20get_media_requests()%20%E6%96%B9%E6%B3%95%E8%BF%94%E5%9B%9E%20None%20%EF%BC%8C%E8%BF%99%E6%84%8F%E5%91%B3%E7%9D%80%E9%A1%B9%E7%9B%AE%E4%B8%AD%E6%B2%A1%E6%9C%89%E5%9B%BE%E7%89%87%E5%8F%AF%E4%B8%8B%E8%BD%BD%E3%80%82**</center></body></html>